---
phase: 06-generic-index-updates
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - crates/y-sweet-core/src/doc_resolver.rs
  - crates/y-sweet-core/src/search_index.rs
  - crates/y-sweet-core/src/link_indexer.rs
autonomous: true

must_haves:
  truths:
    - "DocumentResolver single-doc update reflects path change in both forward and reverse lookups"
    - "DocumentResolver single-doc remove clears both maps and is a no-op when called again"
    - "SearchIndex add_document is idempotent (existing tests already prove this; new test confirms no duplicate results)"
    - "SearchIndex remove_document is idempotent (removing non-existent doc does not error)"
    - "Link index re-index after content change updates backlinks correctly and stale entries self-heal"
    - "Link index re-index for deleted document removes all backlink entries"
  artifacts:
    - path: "crates/y-sweet-core/src/doc_resolver.rs"
      provides: "upsert_doc and remove_doc methods on DocumentResolver"
      contains: "fn upsert_doc"
    - path: "crates/y-sweet-core/src/search_index.rs"
      provides: "Idempotency tests for add_document and remove_document"
      contains: "remove_nonexistent_document_is_noop"
    - path: "crates/y-sweet-core/src/link_indexer.rs"
      provides: "remove_doc_from_backlinks function and test"
      contains: "fn remove_doc_from_backlinks"
  key_links:
    - from: "crates/y-sweet-core/src/doc_resolver.rs"
      to: "DocumentResolver"
      via: "upsert_doc/remove_doc methods"
      pattern: "upsert_doc.*remove_doc"
    - from: "crates/y-sweet-core/src/link_indexer.rs"
      to: "backlinks_v0 Y.Map"
      via: "remove_doc_from_backlinks scans all backlink arrays"
      pattern: "remove_doc_from_backlinks"
---

<objective>
Add single-document CRUD update functions to DocumentResolver and link index, plus idempotency tests for all three indexes.

Purpose: Phase 7 (Move API) needs to call "document path changed" and have all indexes update correctly. Currently, DocumentResolver only supports full-folder refresh (rebuild entire folder from filemeta_v0). The link index has no way to remove all backlinks for a deleted document. SearchIndex already has the right API but lacks explicit idempotency proof for edge cases.

Output: Three modules with generic, idempotent, single-document CRUD operations testable without server infrastructure.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-mcp-read-only-tools/03-01-SUMMARY.md
@crates/y-sweet-core/src/doc_resolver.rs
@crates/y-sweet-core/src/search_index.rs
@crates/y-sweet-core/src/link_indexer.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: DocumentResolver single-doc CRUD methods (TDD)</name>
  <files>crates/y-sweet-core/src/doc_resolver.rs</files>
  <action>
Add two new public methods to DocumentResolver:

**`upsert_doc(&self, uuid: &str, path: &str, info: DocInfo)`**
- If uuid already exists in uuid_to_path, remove the OLD path from path_to_doc first
- Insert/overwrite uuid_to_path[uuid] = path
- Insert/overwrite path_to_doc[path] = info
- This handles creates, path changes (moves), and metadata updates in one idempotent call
- Calling twice with same data is a no-op (DashMap insert overwrites)

**`remove_doc(&self, uuid: &str)`**
- Look up path from uuid_to_path, remove from path_to_doc
- Remove from uuid_to_path
- If uuid not found, return silently (idempotent)

**RED phase tests (write first, expect compile failures):**

1. `upsert_doc_creates_new_entry` - upsert_doc with new uuid creates both forward and reverse entries
2. `upsert_doc_updates_existing_path` - upsert_doc with existing uuid but new path: old path no longer resolves, new path does, uuid_to_path returns new path
3. `upsert_doc_idempotent` - calling upsert_doc twice with same data results in exactly 1 entry (all_paths().len() == 1)
4. `remove_doc_clears_both_maps` - after remove_doc, both resolve_path and path_for_uuid return None
5. `remove_doc_idempotent` - calling remove_doc on non-existent uuid does not panic or error
6. `upsert_doc_with_folder_context` - upsert_doc for doc in folder, verify DocInfo fields match (folder_name, relay_id, doc_id)

Follow existing test pattern in doc_resolver.rs: use the test helper constants (RELAY_ID, FOLDER0_UUID) and create DocInfo manually.

**GREEN phase:** Implement the two methods to pass all tests. Keep it minimal.
  </action>
  <verify>
Run `CARGO_TARGET_DIR=~/code/lens-relay/.cargo-target cargo test --manifest-path=crates/Cargo.toml -p y-sweet-core doc_resolver -- --nocapture` and confirm all tests pass including the 6 new ones.
  </verify>
  <done>
DocumentResolver has upsert_doc and remove_doc methods. Six new tests pass. Existing 11 tests still pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: SearchIndex idempotency edge-case tests + link index remove_doc_from_backlinks (TDD)</name>
  <files>crates/y-sweet-core/src/search_index.rs, crates/y-sweet-core/src/link_indexer.rs</files>
  <action>
**SearchIndex — add 2 edge-case tests proving idempotency (RED then GREEN — these should pass immediately since the API already handles these cases, but we need the explicit proof):**

1. `remove_nonexistent_document_is_noop` - calling remove_document("nonexistent") does not error and subsequent searches still work
2. `add_document_twice_no_duplicates` - calling add_document with same doc_id twice, then searching, returns exactly 1 result (not 2)

These tests exercise existing code paths but prove the idempotency contract explicitly for Phase 7.

**Link Index — add `remove_doc_from_backlinks` function + tests (RED then GREEN):**

Add a new public function to link_indexer.rs:

```rust
/// Remove all backlink entries for a given source UUID from all folder docs.
///
/// Scans backlinks_v0 on each folder doc and removes source_uuid from every
/// backlink array. Removes empty arrays entirely. Idempotent: calling on a
/// UUID with no backlinks is a no-op.
pub fn remove_doc_from_backlinks(
    source_uuid: &str,
    folder_docs: &[&Doc],
) -> anyhow::Result<usize>
```

This function handles the "document deleted" case: remove the document as a backlink source from ALL targets. Returns the number of backlink arrays modified.

**RED phase tests (in link_indexer.rs tests module):**

1. `remove_doc_from_backlinks_clears_source` - Create folder doc with backlinks_v0 where target_A has backlinks [source_X, source_Y]. Call remove_doc_from_backlinks("source_X", &[&folder_doc]). Verify target_A's backlinks are now just [source_Y].
2. `remove_doc_from_backlinks_removes_empty_arrays` - If target_B's backlinks are just [source_X], after removal the key should be removed entirely from backlinks_v0.
3. `remove_doc_from_backlinks_idempotent` - Calling with a UUID that is not in any backlinks array does not error and returns 0.
4. `remove_doc_from_backlinks_multi_folder` - Source appears in backlinks across 2 folder docs; both are cleaned.

**GREEN phase:** Implement remove_doc_from_backlinks. Pattern: for each folder doc, transact_mut_with("link-indexer"), iterate backlinks_v0 keys, filter source_uuid from arrays, remove empty entries.

Note: The existing `index_content_into_folders` / `index_content_into_folders_from_text` already handles the "content changed" case (diff-updates backlinks). `remove_doc_from_backlinks` handles the "document deleted" case that was previously missing.
  </action>
  <verify>
Run `CARGO_TARGET_DIR=~/code/lens-relay/.cargo-target cargo test --manifest-path=crates/Cargo.toml -p y-sweet-core -- --nocapture` and confirm ALL tests pass (search_index, doc_resolver, link_indexer).
  </verify>
  <done>
SearchIndex has 2 new idempotency tests passing. Link index has remove_doc_from_backlinks function with 4 tests passing. All existing tests still pass. All three indexes now have complete, tested CRUD operations: create/update (idempotent upsert), delete (idempotent remove), and content change (diff-update for link index).
  </done>
</task>

</tasks>

<verification>
Run the full y-sweet-core test suite:
```bash
CARGO_TARGET_DIR=~/code/lens-relay/.cargo-target cargo test --manifest-path=crates/Cargo.toml -p y-sweet-core -- --nocapture
```

Verify:
1. All doc_resolver tests pass (11 existing + 6 new = 17)
2. All search_index tests pass (existing + 2 new)
3. All link_indexer tests pass (existing + 4 new)
4. No compilation warnings in the three modified files

Then confirm idempotency contracts:
- DocumentResolver: upsert_doc(same data) twice -> 1 entry
- SearchIndex: add_document(same doc_id) twice -> 1 result
- Link index: remove_doc_from_backlinks(non-existent) -> 0 modifications
</verification>

<success_criteria>
Phase 6 success criteria from ROADMAP.md:
1. Search index update with document metadata re-indexes correctly, repeat is no-op -- PROVEN by add_document_twice_no_duplicates test
2. DocumentResolver update with changed path reflects new path in lookups, repeat is no-op -- PROVEN by upsert_doc_updates_existing_path and upsert_doc_idempotent tests
3. Link index update after wikilink target change updates backlinks correctly -- ALREADY PROVEN by existing index_content_into_folder tests; delete case now covered by remove_doc_from_backlinks
4. All three work for creates, deletes, path changes, content changes -- PROVEN by the full test suite across all three modules
</success_criteria>

<output>
After completion, create `.planning/phases/06-generic-index-updates/06-01-SUMMARY.md`
</output>
