---
phase: 08-move-surfaces
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - lens-editor/src/lib/relay-api.ts
  - lens-editor/src/components/Sidebar/FileTreeContextMenu.tsx
  - lens-editor/src/components/Sidebar/FileTreeContext.tsx
  - lens-editor/src/components/Sidebar/FileTreeNode.tsx
  - lens-editor/src/components/Sidebar/Sidebar.tsx
autonomous: false

must_haves:
  truths:
    - "User can right-click a file in the file tree and see a 'Move to...' option in the context menu"
    - "Clicking 'Move to...' opens a dialog where the user can type a new path and optionally select a different folder"
    - "After confirming the move, the file tree updates to show the file at its new location"
    - "After a move via UI, wikilinks in other documents are rewritten (full pipeline through POST /doc/move)"
    - "Move errors (conflict, not found) are shown to the user"
  artifacts:
    - path: "lens-editor/src/lib/relay-api.ts"
      provides: "moveDocument() function calling POST /doc/move via Vite proxy"
      contains: "moveDocument"
    - path: "lens-editor/src/components/Sidebar/FileTreeContextMenu.tsx"
      provides: "Move to... context menu item"
      contains: "Move to"
    - path: "lens-editor/src/components/Sidebar/Sidebar.tsx"
      provides: "Move handler wiring and move dialog state"
      contains: "handleMove"
  key_links:
    - from: "lens-editor/src/components/Sidebar/Sidebar.tsx"
      to: "lens-editor/src/lib/relay-api.ts"
      via: "import and call moveDocument()"
      pattern: "moveDocument"
    - from: "lens-editor/src/lib/relay-api.ts"
      to: "POST /doc/move"
      via: "fetch('/api/relay/doc/move')"
      pattern: "api/relay/doc/move"
    - from: "lens-editor/src/components/Sidebar/FileTreeContextMenu.tsx"
      to: "lens-editor/src/components/Sidebar/FileTreeContext.tsx"
      via: "onMove callback prop"
      pattern: "onMove"
---

<objective>
Add "Move to..." option in the lens-editor file tree context menu, calling the server's POST /doc/move endpoint.

Purpose: Satisfies requirement UI-04 -- users can move files in the lens-editor via context menu, with server-side backlink rewriting.
Output: Context menu "Move to..." item, move dialog with path input and folder selector, moveDocument API function.
</objective>

<execution_context>
@/home/penguin/.claude/get-shit-done/workflows/execute-plan.md
@/home/penguin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-move-api-backlink-rewriting/07-02-SUMMARY.md

@lens-editor/src/lib/relay-api.ts
@lens-editor/src/lib/multi-folder-utils.ts
@lens-editor/src/components/Sidebar/Sidebar.tsx
@lens-editor/src/components/Sidebar/FileTreeContextMenu.tsx
@lens-editor/src/components/Sidebar/FileTreeContext.tsx
@lens-editor/src/components/Sidebar/FileTreeNode.tsx
@lens-editor/src/components/ConfirmDialog/ConfirmDialog.tsx
@lens-editor/vite.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add moveDocument API function and Move UI to file tree</name>
  <files>
    lens-editor/src/lib/relay-api.ts
    lens-editor/src/components/Sidebar/FileTreeContextMenu.tsx
    lens-editor/src/components/Sidebar/FileTreeContext.tsx
    lens-editor/src/components/Sidebar/FileTreeNode.tsx
    lens-editor/src/components/Sidebar/Sidebar.tsx
  </files>
  <action>
**1. relay-api.ts -- add moveDocument function:**

Add after the existing `searchDocuments` function:

```typescript
export interface MoveDocumentResponse {
  old_path: string;
  new_path: string;
  old_folder: string;
  new_folder: string;
  links_rewritten: number;
}

/**
 * Move a document to a new path, optionally to a different folder.
 * Calls the server's POST /doc/move endpoint which handles:
 * - Metadata update in filemeta_v0
 * - Backlink rewriting in other documents
 * - Search index update
 */
export async function moveDocument(
  uuid: string,
  newPath: string,
  targetFolder?: string
): Promise<MoveDocumentResponse> {
  const body: Record<string, string> = { uuid, new_path: newPath };
  if (targetFolder) {
    body.target_folder = targetFolder;
  }

  const response = await fetch('/api/relay/doc/move', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });

  if (!response.ok) {
    const text = await response.text();
    throw new Error(text || `Move failed: ${response.status}`);
  }

  return response.json();
}
```

The Vite proxy at `/api/relay` already forwards to the relay server (see vite.config.ts), so `/api/relay/doc/move` maps to `POST /doc/move`.

**2. FileTreeContext.tsx -- add onRequestMove callback:**

Add to the `FileTreeContextValue` interface:
```typescript
onRequestMove?: (path: string, docId: string) => void;
```

**3. FileTreeContextMenu.tsx -- add "Move to..." menu item:**

Add `onMove` prop to the interface:
```typescript
interface FileTreeContextMenuProps {
  children: ReactNode;
  onRename: () => void;
  onDelete: () => void;
  onMove: () => void;  // NEW
  isFolder: boolean;
}
```

Add a "Move to..." menu item between Rename and the separator, but only for files (not folders):
```tsx
{!isFolder && (
  <ContextMenu.Item
    className="px-3 py-1.5 text-sm hover:bg-gray-100 cursor-pointer outline-none"
    onSelect={onMove}
  >
    Move to...
  </ContextMenu.Item>
)}
```

**4. FileTreeNode.tsx -- wire move handler:**

Add `handleMove` function:
```typescript
const handleMove = () => {
  if (node.data.docId) {
    ctx.onRequestMove?.(node.data.path, node.data.docId);
  }
};
```

Pass `onMove={handleMove}` to `FileTreeContextMenu`.

**5. Sidebar.tsx -- add move dialog state and handler:**

Add state for the move dialog:
```typescript
const [moveTarget, setMoveTarget] = useState<{ path: string; docId: string } | null>(null);
const [moveNewPath, setMoveNewPath] = useState('');
const [moveTargetFolder, setMoveTargetFolder] = useState<string>('');
const [moveError, setMoveError] = useState<string | null>(null);
const [isMoving, setIsMoving] = useState(false);
```

Import `moveDocument` from `relay-api.ts`.

Add handler:
```typescript
const handleMoveRequest = useCallback((prefixedPath: string, docId: string) => {
  // Pre-populate with current path (strip folder prefix)
  const folderName = getFolderNameFromPath(prefixedPath, folderNames);
  const originalPath = folderName ? getOriginalPath(prefixedPath, folderName) : prefixedPath;
  setMoveTarget({ path: prefixedPath, docId });
  setMoveNewPath(originalPath);
  setMoveTargetFolder(folderName || folderNames[0] || '');
  setMoveError(null);
}, [folderNames]);

const handleMoveConfirm = useCallback(async () => {
  if (!moveTarget || !moveNewPath.trim()) return;
  setIsMoving(true);
  setMoveError(null);
  try {
    // Determine if this is a cross-folder move
    const currentFolder = getFolderNameFromPath(moveTarget.path, folderNames);
    const targetFolder = moveTargetFolder !== currentFolder ? moveTargetFolder : undefined;
    await moveDocument(moveTarget.docId, moveNewPath, targetFolder);
    setMoveTarget(null);
    setMoveNewPath('');
  } catch (err: any) {
    setMoveError(err.message || 'Move failed');
  } finally {
    setIsMoving(false);
  }
}, [moveTarget, moveNewPath, moveTargetFolder, folderNames]);
```

Wire `onRequestMove` into the FileTreeProvider value:
```typescript
onRequestMove: handleMoveRequest,
```

Add a move dialog after the delete ConfirmDialog. Use a simple modal/dialog (can reuse the ConfirmDialog pattern or build inline). The dialog should contain:
- Title: "Move {filename}"
- An input for the new path (pre-populated with current path)
- A dropdown/select for target folder (only show if there are multiple folders, pre-selected to current folder)
- Error message display area (red text)
- Cancel and Move buttons (Move button disabled while isMoving)
- On Enter key in the path input, trigger move

Use Radix Dialog (already available -- ConfirmDialog uses `@radix-ui/react-alert-dialog`). For the move dialog, use `@radix-ui/react-dialog` (check if it's installed, if not use the existing alert-dialog pattern with a custom overlay). Actually, the simplest approach: create the dialog inline in Sidebar.tsx using the same styling patterns as ConfirmDialog.

Check if `@radix-ui/react-dialog` is in package.json. If yes, use it. If not, build the dialog with a simple conditional render + overlay (position: fixed, z-50, backdrop) -- no need to add a dependency for one dialog.

The folder selector only appears when `folderNames.length > 1`. It's a simple `<select>` element with the folder names as options.

Note: The file tree updates automatically after a successful move because the server-side move modifies filemeta_v0 in the Y.Doc, which propagates via Y.js to the connected lens-editor client. The filemeta Y.Map observer fires, the `useFolderMetadata` hook re-renders, and the tree rebuilds. No manual tree update needed on the client side.
  </action>
  <verify>
Run `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx tsc --noEmit 2>&1 | tail -5` -- TypeScript compiles without errors.
Run `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx vitest run 2>&1 | tail -10` -- existing tests pass.
  </verify>
  <done>Context menu shows "Move to..." for files. Clicking it opens a dialog with path input and folder selector. moveDocument() calls POST /doc/move via Vite proxy. TypeScript compiles. Existing tests pass.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify file tree move UI with live server</name>
  <files>lens-editor/src/components/Sidebar/Sidebar.tsx</files>
  <what-built>File tree "Move to..." context menu with move dialog, calling the server move API</what-built>
  <action>Human verification of the live file tree move UI.</action>
  <how-to-verify>
    1. Start relay server if not running: `cd /home/penguin/code/lens-relay/ws1/lens-editor && npm run relay:start`
    2. Set up test docs: `cd /home/penguin/code/lens-relay/ws1/lens-editor && npm run relay:setup`
    3. Generate share link: `cd /home/penguin/code/lens-relay/ws1/lens-editor && npx tsx scripts/generate-share-link.ts --role edit --folder b0000001-0000-4000-8000-000000000001 --base-url http://dev.vps:5173`
    4. Start dev server: `cd /home/penguin/code/lens-relay/ws1/lens-editor && npm run dev:local`
    5. Open the editor at http://dev.vps:5173 (use generated share link)
    6. Right-click a file in the file tree -- verify "Move to..." appears in context menu
    7. Click "Move to..." -- verify dialog opens with current path pre-populated
    8. Change the path (e.g. add a subfolder prefix like "/subfolder/filename.md") and click Move
    9. Verify the file tree updates to show the file at the new location
    10. Verify no console errors in browser dev tools
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
  <verify>Human verifies context menu shows "Move to..." for files, dialog opens, and move updates the file tree.</verify>
  <done>File tree move UI works end-to-end with live relay server.</done>
</task>

</tasks>

<verification>
- TypeScript compiles without errors
- Existing lens-editor tests pass
- Context menu shows "Move to..." for files (not folders)
- Move dialog opens with pre-populated path and folder selector
- Successful move updates file tree automatically (Y.js propagation)
- Move errors displayed in dialog
</verification>

<success_criteria>
User can right-click a file in the lens-editor file tree, select "Move to...", enter a new path (and optionally a different folder), and the file moves with backlinks rewritten. The tree updates automatically. Errors are shown in the dialog.
</success_criteria>

<output>
After completion, create `.planning/phases/08-move-surfaces/08-02-SUMMARY.md`
</output>
